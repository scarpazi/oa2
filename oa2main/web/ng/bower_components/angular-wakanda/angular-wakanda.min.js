/*! angular-wakanda - v1.0.2 - 2015-12-16 */!function(a,b){function c(a){var b=new Date;return b.setISO(a),b}function d(a){if(null==a||""==a)return null;var b=a.split("!");return b.length<3?null:new Date(Number(b[2]),Number(b[1])-1,Number(b[0]))}b["true"]=a;var f;!function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;f=function(){},f.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}();var g={core:{},config:{}};Date.prototype.toJSON=function(a){return this.toISO()+","+this.toSimpleDateString()},Date.prototype.toSimpleDateString=function(){return""+this.getDate()+"!"+(this.getMonth()+1)+"!"+(this.getYear()+1900)},Date.prototype.setISO=function(a){var b="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",c=a.match(new RegExp(b)),d=0,e=new Date(c[1],0,1);c[3]&&e.setMonth(c[3]-1),c[5]&&e.setDate(c[5]),c[7]&&e.setHours(c[7]),c[8]&&e.setMinutes(c[8]),c[10]&&e.setSeconds(c[10]),c[12]&&e.setMilliseconds(1e3*Number("0."+c[12])),c[14]&&(d=60*Number(c[16])+Number(c[17]),d*="-"==c[15]?1:-1),d-=e.getTimezoneOffset(),time=Number(e)+60*d*1e3,this.setTime(Number(time))},Date.prototype.toISO=function(a,b){if(!a)var a=6;if(b){var c=b.match(/([-+])([0-9]{2}):([0-9]{2})/),d=60*Number(c[2])+Number(c[3]);d*="-"==c[1]?-1:1;var e=new Date(Number(Number(this)+6e4*d))}else var b="Z",e=this;var f=function(a){return(10>a?"0":"")+a},g="";if(g+=e.getUTCFullYear(),a>1&&(g+="-"+f(e.getUTCMonth()+1)),a>2&&(g+="-"+f(e.getUTCDate())),a>3&&(g+="T"+f(e.getUTCHours())+":"+f(e.getUTCMinutes())),a>5){var h=Number(e.getUTCSeconds()+"."+(e.getUTCMilliseconds()<100?"0":"")+f(e.getUTCMilliseconds()));g+=":"+f(h)}else a>4&&(g+=":"+f(e.getUTCSeconds()));return a>3&&(g+=b),g},Date.prototype.isValid=function(){return!isNaN(this.getTime())},g.core.restConnect={},g.core.restConnect.httpMethods={_post:"POST",_get:"GET",_put:"PUT",_delete:"DELETE"},g.core.restConnect.restActions={_retrieve:"retrieve",_create:"create",_update:"update",_delete:"delete"},g.core.restConnect.queryOptions={_expand:"$expand",_orderby:"$orderby",_skip:"$skip",_top:"$top",_filter:"$filter"},g.core.restConnect.filterOperators={_equal:"eq",_notequal:"neq",_greaterthan:"gt",_greaterthanorequal:"gteq",_lessthan:"lt",_lessthanorequal:"lteq",_logicaland:"and",_logicalor:"or",_logicalnot:"not"},g.core.restConnect.filterArithmeticOperators={_add:"add",_sub:"sub",_mul:"mul",_div:"div",_mod:"mod"},g.core.restConnect.defaultService="rest",g.core.restConnect.standardErrors={_hostnamemissing:{key:"1",string:"The hostname is missing."},_servicemissing:{key:"2",string:"The service is missing."},_httpmethodundefined:{key:"3",string:"The HTTP method is undefined."},_wronghttpmethod:{key:"4",string:"The HTTP method get doesn't support POST data."}},g.core.restConnect.getXMLHttpRequest=function(){var a=!1;return window.XMLHttpRequest?a=new XMLHttpRequest:window.ActiveXObject,a},g.core.restConnect.restRequest=function(a){this.connectionMode=a,this.fullURL=null,this.httpMethod=g.core.restConnect.httpMethods._get,this.hostname="",this.app=g.config.pattern,this.service=g.core.restConnect.defaultService,this.resource="",this.attributesRequested=void 0,this.keys=[],this.expand=[],this.orderby=[],this.skip=null,this.top=null,this.filter=null,this.method=null,this.metadata=null,this.handler=null,this.postdata=null,this.postAFile=!1,this.queryPlan=null,this.progressInfo=null,this.distinct=!1,this.refreshOnly=!1,this.error={key:0,string:""},this.orderByArgsToString=function(){var a="";if("string"==typeof this.orderby)return this.orderby;this.orderby.length>0&&(a=this.orderby[0]);for(var b=1;b<this.orderby.length;b++)a+=","+this.orderby[b];return a},this.go=function(a){var b=this.handler,c=(g.hostname?g.hostname:"")+"/";if(null!=this.app&&(c=this.app+"/"),""===this.service)return this.error=g.core.restConnect.standardErrors._servicemissing,!1;if(c+=this.service+"/",""!==this.resource&&(c+=this.resource+"/",this.keys.length>0)){c+="(";for(var d=0;d<this.keys.length;d++)c+=this.keys[d],d<this.keys.length-1&&(c+=",");c+=")"}var e=!1;this.dataURI&&(c=this.dataURI,e=-1!==c.indexOf("?"),e||(c+="/"));var f=!e;if(void 0!=this.attributesRequested){if(this.attributesRequested.length>0){c+=this.attributesRequested[0];for(var d=1;d<this.attributesRequested.length;d++)c+=","+this.attributesRequested[d]}c+="/"}var h="";if(this.skip&&(h+=(e?"&$skip=":"$skip=")+this.skip,e=!0),this.top&&(h+=(e?"&$top=":"$top=")+this.top,e=!0),this.filter&&(h+=(e?"&$filter=":"$filter=")+encodeURIComponent("'"+this.filter+"'"),e=!0),this.params&&(h+=(e?"&$params=":"$params=")+encodeURIComponent("'"+JSON.stringify(this.params).replace(/'/g,"\\u0027")+"'"),e=!0),this.method&&(h+=(e?"&$method=":"$method=")+this.method,e=!0),this.asArray&&(h+=(e?"&$asArray=":"$asArray=")+"true",e=!0),this.metadata&&(h+=(e?"&$metadata=":"$metadata=")+this.metadata,e=!0),null!=this.mustlock&&(h+=(e?"&$lock=":"$lock=")+this.mustlock,e=!0),this.distinct&&(h+=(e?"&$distinct=":"$distinct=")+this.distinct,e=!0),null!=this.findKey&&(h+=(e?"&$findKey=":"$findKey=")+encodeURIComponent(""+this.findKey),e=!0),null!=this.reselect&&(h+=(e?"&$reselect=":"$reselect=")+encodeURIComponent(""+this.reselect),e=!0),this.queryPlan&&(h+=e?"&$queryplan=true&querypath=true":"$queryplan=true&querypath=true",e=!0),this.progressInfo&&(h+=(e?"&$progressinfo=":"$progressinfo=")+encodeURIComponent(this.progressInfo),e=!0),this.timeout&&(h+=(e?"&$timeout=":"$timeout=")+this.timeout,e=!0),this.savedQueryString&&(h+=(e?"&$savedfilter=":"$savedfilter=")+encodeURIComponent("'"+this.savedQueryString+"'"),e=!0),this.savedOrderby&&(h+=(e?"&$savedorderby=":"$savedorderby=")+this.savedOrderby,e=!0),this.refreshOnly&&(h+=(e?"&$refresh=":"$refresh=")+this.refreshOnly,e=!0),this.atOnce&&(h+=(e?"&$atOnce=":"$atOnce=")+this.atOnce,e=!0),this.postAFile&&(h+=e?"&$rawPict=true":"$rawPict=true",e=!0),this.retainPositions&&(h+=(e?"&$retainPositions=":"$retainPositions=")+this.retainPositions,e=!0),null!=this.removeAtPos&&(h+=(e?"&$removeFromSet=":"$removeFromSet=")+this.removeAtPos,e=!0),null!=this.removeReferenceOnly&&(h+=(e?"&$removeRefOnly=":"$removeRefOnly=")+this.removeReferenceOnly,e=!0),null!=this.filterAttributes&&(h+=(e?"&$attributes=":"$attributes=")+encodeURIComponent(this.filterAttributes),e=!0),null!=this.addToSet&&(h+=(e?"&$addToSet=":"$addToSet=")+encodeURIComponent("'"+JSON.stringify(this.addToSet)+"'"),e=!0),null!=this.fromSelection&&(h+=(e?"&$fromSel=":"$fromSel=")+encodeURIComponent("'"+JSON.stringify(this.fromSelection)+"'"),e=!0),null!=this.keepSelection&&(h+=(e?"&$keepSel=":"$keepSel=")+encodeURIComponent("'"+JSON.stringify(this.keepSelection)+"'"),e=!0),this.orderby&&this.orderby.length&&(h+=e?"&$orderby="+this.orderByArgsToString():"$orderby="+this.orderByArgsToString(),e=!0),null!=this.subOrderby&&(h+=(e?"&$subOrderby=":"$subOrderby=")+encodeURIComponent(this.subOrderby),e=!0),void 0!=this.attributesExpanded&&this.attributesExpanded.length>0){var i="";h+=e?"&$expand=":"$expand=",e=!0;for(var d=0;d<this.attributesExpanded.length;d++)i+=""===i?this.attributesExpanded[d]:","+this.attributesExpanded[d];h+=i}null!=this.autoExpand&&""!=this.autoExpand&&(h+=e?"&$expand=":"$expand=",e=!0,h+=this.autoExpand),null!=this.autoSubExpand&&""!=this.autoSubExpand&&(h+=e?"&$subExpand=":"$subExpand=",e=!0,h+=this.autoSubExpand),""!==h&&(f&&(c+="?"),c+=h);var j="";if(""!==this.httpMethod?j=this.httpMethod:this.error=g.core.restConnect.httpMethods._get,this.postdata&&j==g.core.restConnect.httpMethods._get)return this.error=g.core.restConnect.standardErrors._wronghttpmethod,!1;if(this.http_request=g.core.restConnect.getXMLHttpRequest(),this.http_request){if(this.http_request.parent=this,a&&a.generateRESTRequestOnly)return c;null!=b&&(this.http_request.onreadystatechange=function(){b(this.parent)});try{return this.fullURL&&(c=this.fullURL),this.http_request.open(j,c,this.connectionMode),this.postdata&&(this.postAFile?this.http_request.setRequestHeader("Content-Type",this.postdata.type):this.http_request.setRequestHeader("Content-Type","application/json")),this.http_request.setRequestHeader("If-Modified-Since","Thu, 1 Jan 1970 00:00:00 GMT"),this.http_request.setRequestHeader("Cache-Control","no-cache"),this.http_request.send(this.postdata),this.connectionMode||b(this.http_request),!0}catch(k){return!0}return!1}}},g.callHandler=function(a,b,c,d,e){var f=null;if(c.userData=e,a){var g=d.onError;c.error=b,null!=g&&(f=g(c))}else{var h=d.onSuccess;null!=h&&(f=h(c))}return f},g.getRequestResult=function(a){var b,c=a.http_request.responseText;if(null==c)b={__ERROR:[{errCode:-1}]};else try{b=JSON.parse(c)}catch(d){b={__ERROR:[d]}}return b},g.tools={},g.tools.optionMatchers=["onSuccess","onError","atTheEnd","sync","autoExpand","autoSubExpand","catalog","queryString","skip","top","position","orderby","orderBy","params","queryPlan","queryPath","pageSize","filterSet","progressInfo","progressBar","delay","delayInfo","method","first","limit","userData","addToSet","atOnce","refreshOnly","keepOldCollectionOnError","isMethodResult","prefetchedData","callWithGet","generateRESTRequestOnly","forceReload","doNotAlterElemPos","overrideStamp","queryParams","createEmptyCollection","forceCollectionRefresh","refreshCollectionFrom","removeReferenceOnly","timeout","doNotDispatch","destinationDataSource","filterAttributes","subOrderby","filterQuery","withinCollection","keepOrderBy","retainPositions","fromInitialQuery","reselect"],g.tools.isOptionParam=function(a){var b=!1;if(null!=a&&"object"==typeof a)for(var c=g.tools.optionMatchers,d=c.length,e=0;d>e&&!b;++e){var f=c[e];if(f in a){b=!0;break}}return b},g.tools.handleArgs=function(a,b,c){var d=!1;c=c||{},b=b||0;var e,f=c.noUserData||!1,h=c.with3funcs||!1,i=c.queryParams||!1,j={options:{},userData:null},k=a.length,l=b;k>l&&(e=a[l],"function"==typeof e&&(j.options.onSuccess=e,++l,k>l&&(e=a[l],"function"==typeof e&&(j.options.onError=e,++l,k>l&&(e=a[l],h&&"function"==typeof e&&(j.options.atTheEnd=e,++l)))),null==j.options.onError&&(j.options.onError=j.options.onSuccess)));var m=null;i&&(m=[]);do if(k>l)if(e=a[l],!d&&g.tools.isOptionParam(e)){d=!0,++l;var n=j.options;j.options=e,null!=n.onSuccess&&(j.options.onSuccess=n.onSuccess),null!=n.onError&&(j.options.onError=n.onError),null!=n.atTheEnd&&(j.options.atTheEnd=n.atTheEnd),i||k>l&&!f&&(j.userData=a[l],++l)}else i&&("object"!=typeof e||e instanceof Date||e instanceof Array?(m.push(e),++l):(j.userData=e,++l));while(i&&k>l);return null!=j.options.userData&&null==j.userData&&(j.userData=j.options.userData),i&&(j.options.params=j.options.params||m),j.nextParam=l,j},g.EntityCache=function(a){a=a||{};this.maxEntities=a.maxEntities||300,this.timeOut=a.timeOut||3e5,this.entitiesByKey={},this.nbEntries=0,this.curStamp=0},g.EntityCache.prototype.getNextStamp=function(){var a=this;return a.curStamp++,a.curStamp},g.EntityCache.prototype.clear=function(a){var b=this;if(null==a||a>=b.nbEntries)b.entitiesByKey={},b.nbEntries=0;else{var c=[],d=b.entitiesByKey;for(var e in d)c.push(d[e]);c.sort(function(a,b){return a.timeStamp>b.timeStamp?1:-1});var f=a;f>c.length&&(f=c.length);for(var g=b.nbEntries,h=0;f>h;h++){var i=c[h];delete d[i.key],--g}b.nbEntries=g,delete c}},g.EntityCache.prototype.makeRoomFor=function(a){var b=this;b.maxEntities<2*a&&(b.maxEntities=2*a);var c=b.maxEntities-b.nbEntries;a>c&&b.clear(a-c)},g.EntityCache.prototype.setEntry=function(a,b,c,d){function f(a,b){for(e in b){var c=a[e];null==c?a[e]=b[e]:null!=c.__deferred&&(a[e]=b[e])}return a}var g=this,h=g.entitiesByKey,i=h[a];if(null==i)g.nbEntries>=g.maxEntities&&g.clear(Math.round(g.nbEntries/3)),g.nbEntries++;else{var j=-1,k=null;null!=b&&(k=b.__STAMP),null!=i.rawEntity&&(j=i.rawEntity.__STAMP),j===k&&(b=f(b,i.rawEntity))}var l=g.getNextStamp();return h[a]={key:a,timeStamp:c,rawEntity:b,stamp:l},l},g.EntityCache.prototype.getCacheInfo=function(a){var b=this,c=b.entitiesByKey[a];return c},g.EntityCache.prototype.replaceCachedEntity=function(a,b){var c=this,d=c.entitiesByKey[a];null!=d&&(d.timeStamp=new Date,d.rawEntity=b,d.stamp=c.getNextStamp())},g.EntityCache.prototype.removeCachedEntity=function(a){var b=this,c=b.entitiesByKey[a];null!=c&&delete b.entitiesByKey[a]},g.EntityCache.prototype.setSize=function(a){(null==a||300>a)&&(a=300),this.maxEntities=a},g.EntityRefCache=function(a){a=a||{};this.maxEntities=a.maxEntities||300,this.timeOut=a.timeOut||3e5,this.entitiesByKey={},this.nbEntries=0,this.curStamp=0},g.EntityRefCache.prototype.clear=function(a){var b=this;if(null==a||a>=b.nbEntries)b.entitiesByKey={},b.nbEntries=0;else{var c=[],d=b.entitiesByKey;for(var e in d)c.push(d[e]);c.sort(function(a,b){return a.timeStamp>b.timeStamp?1:-1});var f=a;f>c.length&&(f=c.length);for(var g=b.nbEntries,h=0;f>h;h++){var i=c[h];delete d[i.key],--g}b.nbEntries=g,delete c}},g.EntityRefCache.prototype.makeRoomFor=function(a){var b=this;b.maxEntities<2*a&&(b.maxEntities=2*a);var c=b.maxEntities-b.nbEntries;a>c&&b.clear(a-c)},g.EntityRefCache.prototype.setEntry=function(a){var b=a.getKey();if(null!=b){var c=this,d=c.entitiesByKey,e=d[b],f=new Date;null==e?(c.nbEntries>=c.maxEntities&&c.clear(Math.round(c.nbEntries/3)),c.nbEntries++,d[b]={key:b,timeStamp:f,entity:a}):(e.entity!==a&&c.mergeEntity(e.entity,a),e.timeStamp=f)}},g.EntityRefCache.prototype.mergeEntity=function(a,b){a._private.stamp=b._private.stamp,a._private.touched=!1;var c=a._private.values,d=b._private.values,e=a._private.dataClass._private.attributesByName;for(var f in e){var g=d[f]||null;null==g?(delete c[f],delete a[f]):(c[f]=g,a[f]=g)}},g.EntityRefCache.prototype.getCacheInfo=function(a){var b=this,c=b.entitiesByKey[a];return c},g.EntityRefCache.prototype.removeCachedEntity=function(a){var b=this,c=b.entitiesByKey[a];null!=c&&delete b.entitiesByKey[a]},g.EntityRefCache.prototype.setSize=function(a){(null==a||300>a)&&(a=300),this.maxEntities=a},g.DataStore=function(a,b){a=a||{},b=b;var c=this;this._private={owner:this,dataClasses:{},dataClassesByCollectionName:{},ready:!1,cacheRef:a.cacheRef||!1,getCatalog:g.DataStore.getCatalog},c._private.getCatalog(a,b)},g.DataStore.prototype.getDataClass=function(a){var b=this._private,c=b.dataClasses[a];return null==c&&(c=b.dataClassesByCollectionName[a]),c},g.DataStore.prototype.getDataClasses=function(){var a=this._private;return a.dataClasses},g.DataStore.prototype.mustCacheRef=function(){return this._private.cacheRef},g.DataStore.prototype.addToCatalog=function(a,b,c){c=c||null,b=b||{};var d=this._private;b.catalog=a,b.mergeCatalog=!0,d.getCatalog(b,c)},g.DataStore.resolveRelatedAttribute=function(){if(!this.resolved){var a=this.owner.getDataStore();this.relatedClass=a.getDataClass(this.type),null!=this.relatedClass&&(this.resolved=!0)}},g.DataStore.getRelatedClassAttribute=function(){return this.resolve(),this.relatedClass},g.DataStore.handleFuncResult=function(a,b,c){var d=g.getRequestResult(a);if(null==d.__ERROR)if(null!=d.__entityModel&&(c=c.getDataStore().getDataClass(d.__entityModel)),null!=d.__KEY||null!=d.__STAMP){var e=new g.Entity(c,d,{getRefFromCache:!0});d={result:e}}else if(null!=d.__ENTITIES){var f=new g.EntityCollection(c,null,{prefetchedData:d,isMethodResult:!0});d={result:f}}return d},g.DataStore.funcCaller=function(a,b,c,d){var e=null;d=d||{};var f=d.sync||!1,h=a.callWithGet||d.callWithGet||!1,i=d.generateRESTRequestOnly||!1,j=new g.core.restConnect.restRequest(!f);h?j.httpMethod=g.core.restConnect.httpMethods._get:j.httpMethod=g.core.restConnect.httpMethods._post;var k=null,l=null,m=null,n=JSON.stringify(c);if(h?j.params=c:j.postdata=n,"entity"==a.applyTo){k=b,l=k.getDataClass(),j.attributesRequested=[a.name],j.resource=l.getNameForRest()+"(";var o=k.getKey();null!=o&&(j.resource+=o),j.resource+=")"}else"entityCollection"==a.applyTo?(m=b,l=m.getDataClass(),null!=m._private.dataURI?j.dataURI=m._private.dataURI+"/"+a.name:(j.attributesRequested=[a.name],j.resource=l.getNameForRest(),j.filter=d.queryString),j.savedQueryString=m._private.savedQuery,j.savedOrderby=m._private.savedOrderby,m._private.updateOptions(d)):"general"==a.applyTo?(j.resource=a.nameSpace,j.attributesRequested=[a.name]):(l=b,j.attributesRequested=[a.name],j.resource=l.getNameForRest());var p=d.pageSize||40;if(j.top=p,j.method="entityset",j.timeout=300,j.addToSet=d.addToSet,null!=d.autoExpand&&(j.autoExpand=d.autoExpand),null!=d.filterAttributes&&(j.filterAttributes=d.filterAttributes),f||(j.handler=function(){if(4==j.http_request.readyState){var b=g.DataStore.handleFuncResult(j,a,l),c={result:b.result},e=b.__ERROR,f=d.userData||null;c.XHR=j.http_request,g.callHandler(null!=e,e,c,d,f)}}),i)e=j.go({generateRESTRequestOnly:!0});else if(j.go(),f){var q,r;if(q=function(){},r=function(){},c.length>0&&(c[0]&&"function"==typeof c[0]&&(q=c[0]),c[1]&&"function"==typeof c[1]&&(r=c[1])),4!=j.http_request.readyState)throw{error:401};var s=g.DataStore.handleFuncResult(j,a,l);if(null!=s.__ERROR)throw r(s),s.__ERROR;e=s.result,q(e)}return e},g.DataStore.callMethod=function(a){var b=null,c=this,d=c._private.dataClassMethodRefs[a.method];if(null!=d){var e=[];if(null!=a.arguments)e=a.arguments;else for(var f=1,h=arguments.length;h>f;f++)e.push(arguments[f]);b=g.DataStore.funcCaller(d,c,e,a)}return b},g.DataStore.makeFuncCaller=function(a){var b=a,c=function(){for(var a,c=!1,d=[],e=0,f=arguments.length;f>e;e++){var h=arguments[e];!c&&g.tools.isOptionParam(h)?(a=h,c=!0):d.push(h)}var i=a||{};return void 0===i.onSuccess&&void 0===i.onError&&void 0===i.generateRESTRequestOnly&&(i.sync=!0),g.DataStore.funcCaller(b,this,d,i)};return c},g.DataStore.getCatalog=function(a,b){var c=this,d=this.owner,e=g.tools.handleArgs(arguments,0);b=e.userData,a=e.options;var f=a.mergeCatalog||!1,h=!1,i="$all";c.cacheRef=c.cacheRef||a.cacheRef||!1;var j="",k=null;if(null!=a.catalogName&&"string"==typeof a.catalogName&&(j=a.catalogName+"/",k=a.catalogName),null!=a.catalog&&(i="string"==typeof a.catalog?a.catalog:a.catalog.join(","),f&&(classList=i.split(","),newlist=[],classList.forEach(function(a){""!=a&&null==d[a]&&newlist.push(a)}),0==newlist.length&&(h=!0))),h){var l={dataStore:d,result:d};g.callHandler(!1,null,l,a,b)}else{i="$catalog/"+j+i;var m=new g.core.restConnect.restRequest(!0);m.resource=i,m.handler=function(){if(4==m.http_request.readyState){var e=!1,f=null,h=null;try{var i=g.getRequestResult(m);i&&i.dataClasses?f=i.dataClasses:i&&i.className&&(f=[i]),null==f&&(f=[]),null!=i.__ERROR&&(e=!0,h=i.__ERROR)}catch(j){f=[],e=!0,h=j}for(var l=0,n=f.length;n>l;l++){var o=f[l],p=o.name;if(null==d[p]){var q=o.collectionName,r=new g.DataClass(o,d,k);c.dataClasses[p]=r,null!=q&&(c.dataClassesByCollectionName[q]=r),d[p]=r}}c.ready=!0;var s={dataStore:d,result:d};s.XHR=m.http_request,g.callHandler(e,h,s,a,b)}};m.go()}},g.DataClass=function(a,b,c){var d=this,e="";a.key&&(e=a.key[0].name),d._private={primaryKey:e,className:a.name,collectionName:a.collectionName,attributesByName:{},entityMethods:{},entityCollectionMethods:{},entityMethodRefs:{},entityCollectionMethodRefs:{},dataClassMethodRefs:{},owner:d,dataStore:b,catalogPrefix:c,cache:new g.EntityCache,refCache:new g.EntityRefCache,defaultTopSize:a.defaultTopSize,getEntityByURIOrKey:g.DataClass.getEntityByURIOrKey};var f=d._private,h=f.attributesByName,i=f.dataClassMethodRefs,j=f.entityCollectionMethodRefs,k=f.entityMethodRefs,l=f.entityCollectionMethods,m=f.entityMethods,n=a.attributes,o=a.methods;if(f.methods=o,null!=n)for(var p=0,q=n.length;q>p;p++){var r=n[p];r.owner=d,h[r.name]=r,"storage"==r.kind||"calculated"==r.kind||"alias"==r.kind||"composition"==r.kind?(r.simple=!0,r.related=!1,("image"==r.type||"blob"==r.type)&&(r.simple=!1)):(r.simple=!1,r.related=!0,r.resolved=!1,r.relatedOne="relatedEntity"==r.kind,r.resolve=g.DataStore.resolveRelatedAttribute,r.getRelatedClass=g.DataStore.getRelatedClassAttribute,r.relatedClass=null),d[r.name]=r}f.attributes=n;var s=o;if(null!=s)for(var p=0,t=s.length;t>p;p++){var u=s[p];"entity"==u.applyTo?(k[u.name]=u,m[u.name]=g.DataStore.makeFuncCaller(u)):"entityCollection"==u.applyTo?(j[u.name]=u,l[u.name]=g.DataStore.makeFuncCaller(u)):(i[u.name]=u,d[u.name]=g.DataStore.makeFuncCaller(u))}return this},g.DataClass.getEntityByURIOrKey=function(a,b,c,d){var e=g.tools.handleArgs(arguments,2);d=e.userData,c=e.options;var f=this,h=f.owner,i=new g.core.restConnect.restRequest(!0);null!=b?i.fullURL=b:i.resource=h.getNameForRest()+"("+a+")",i.autoExpand=c.autoExpand,i.autoSubExpand=c.autoSubExpand,i.filterAttributes=c.filterAttributes,i.handler=function(){if(4==i.http_request.readyState){var a=!1,b=null,e=g.getRequestResult(i);null!=e.__ERROR&&(a=!0,b=e.__ERROR);var f=null;if(!a){var j=h.mustCacheRef();if(f=new g.Entity(h,e,{getRefFromCache:j}),!j){var k=f.getKey(),l=h.getCache(),m=l.getCacheInfo(k);if(null==m){var n=new Date;l.setEntry(k,e,n)}else l.replaceCachedEntity(k,e)}}var o={entity:f,result:f};o.XHR=i.http_request,g.callHandler(a,b,o,c,d)}};i.go()},g.DataClass.mustCacheRef=function(){return this._private.dataStore.mustCacheRef()},g.DataClass.getName=function(){return this._private.className},g.DataClass.getNameForRest=function(){var a=this._private.className;return null!=this._private.catalogPrefix&&(a=this._private.catalogPrefix+"/"+a),a},g.DataClass.getCollectionName=function(){return this._private.collectionName},g.DataClass.getDefaultTopSize=function(){return this._private.defaultTopSize},g.DataClass.getDataStore=function(){return this._private.dataStore},g.DataClass.getCache=function(){return this._private.cache},g.DataClass.getRefCache=function(){return this._private.refCache},g.DataClass.setCacheSize=function(a){var b=this._private.cacheRef?this._private.refCache:this._private.cache;b.setSize(a)},g.DataClass.getCacheSize=function(){var a=this._private.cacheRef?this._private.refCache:this._private.cache;return a.maxEntities},g.DataClass.clearCache=function(){var a=this._private.cacheRef?this._private.refCache:this._private.cache;a.clear()},g.DataClass.getAttributeByName=function(a){var b=this;return b._private.attributesByName[a]},g.DataClass.getAttributes=function(){var a=this;return a._private.attributes},g.DataClass.getMethodList=function(){var a=this;return a._private.methods},g.DataClass.newEntity=function(){var a=new g.Entity(this);return a},g.DataClass.getEntity=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this;if(e.mustCacheRef()){var f,h=e.getRefCache();if(f=b.forceReload?null:h.getCacheInfo(a),null==f)e._private.getEntityByURIOrKey(a,null,b,c);else{var i=f.entity,j={entity:i,result:i},k=g.callHandler(!1,null,j,b,c);"boolean"==typeof k&&(k||null!=b&&(b.mustStopLoop=!0))}}else{var f,h=e.getCache();if(f=b.forceReload?null:h.getCacheInfo(a),null==f||null==f.rawEntity)e._private.getEntityByURIOrKey(a,null,b,c);else{var i=new g.Entity(e,f.rawEntity),j={entity:i,result:i},k=g.callHandler(!1,null,j,b,c);"boolean"==typeof k&&(k||null!=b&&(b.mustStopLoop=!0))}}},g.DataClass.newCollection=function(a,b,c){if(null==a){var d=new g.EntityCollection(this,null,{createEmptyCollection:!0});return d}var e=g.tools.handleArgs(arguments,1);c=e.userData,b=e.options,b.dataURI=a.dataURI,b.pageSize=b.pageSize||a.pageSize,b.autoExpand=b.autoExpand||a.autoExpand,b.filterAttributes=b.filterAttributes||a.filterAttributes,b.savedQuery=a.savedQuery||null,b.savedOrderby=a.savedOrderby||null;var d=new g.EntityCollection(this,null,b,c);return d},g.DataClass.getEntityByURI=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this;e._private.getEntityByURIOrKey(null,a,b,c)},g.DataClass.distinctValues=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=b.queryString,f=b.skip,h=b.top,i=this,j=new g.core.restConnect.restRequest(!0);j.resource=i.getNameForRest(),j.filter=e,j.skip=f,j.top=h,j.options={objectRef:this,first:f,top:h},null!=a&&(j.attributesRequested=[a]),j.distinct=!0,j.addToSet=b.addToSet,j.handler=function(){if(4==j.http_request.readyState){var a=g.getRequestResult(j),d=!1,e=null;if(null!=a.__ERROR){e=a.__ERROR,d=!0;for(var f=0;f<a.__ERROR.length;f++){var h=a.__ERROR[f];null==h.options&&(h.options={}),h.options.position=first}}var i={result:a,distinctValues:a,XHR:j.http_request};g.callHandler(d,e,i,b,c)}},j.go()},g.DataClass.query=function(a,b,c){var d=g.tools.handleArgs(arguments,1,{queryParams:!0});c=d.userData,b=d.options;var e=this,f=new g.EntityCollection(e,a,b,c);return f},g.DataClass.allEntities=function(a,b){var c=g.tools.handleArgs(arguments,0);return b=c.userData,a=c.options,this.query("",a,b)},g.DataClass.find=function(a,b,c){var d=g.tools.handleArgs(arguments,1,{queryParams:!0});c=d.userData,b=d.options;var e=this,f=(this._private,new g.core.restConnect.restRequest(!0));f.resource=e.getNameForRest(),f.autoExpand=b.autoExpand,f.filterAttributes=b.filterAttributes,f.filter=a,f.top=1,f.orderby=b.orderby,f.params=b.params,f.handler=function(){if(4==f.http_request.readyState){var a=!1,d=null,h=g.getRequestResult(f);null!=h.__ERROR&&(a=!0,d=h.__ERROR);var i=null;!a&&null!=h.__ENTITIES&&h.__ENTITIES.length>0&&(i=new g.Entity(e,h.__ENTITIES[0],{getRefFromCache:!0}));var j={entity:i,result:i,XHR:f.http_request};g.callHandler(a,d,j,b,c)}};f.go()},g.DataClass.toArray=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,f=new g.core.restConnect.restRequest(!0);f.resource=this.getNameForRest(),f.top=b.top||null,f.skip=b.skip||null,f.addToSet=b.addToSet,f.retainPositions=b.retainPositions||null,f.progressInfo=b.progressInfo,f.orderby=b.orderby,f.autoExpand=a,f.asArray=!0,b.filterQuery&&(f.filter=b.filterQuery,f.params=b.params),f.handler=function(){if(4==f.http_request.readyState){var a=g.getRequestResult(f),d={dataClass:e,result:a,XHR:f.http_request},h=null!=a.__ERROR;g.callHandler(h,a.__ERROR,d,b,c)}};f.go()},g.EntityCollectionPage=function(a,b){this.start=a,this.length=b,this.entityKeys=[]},g.EntityCollection=function(a,b,c,d){("''"==b||""==b)&&(b=null);var e=g.tools.handleArgs(arguments,2);d=e.userData,c=e.options;var f,h=c.filterSet;null!=h?(f=h._private.savedQuery,null!=f?null!=b&&(f="("+f+") and "+b):saveQuery=b):f=b,null==f&&(f=c.savedQuery||null),null==c.orderby&&null!=c.orderBy&&(c.orderby=c.orderBy);var i=c.orderby||null;null==i&&(i=c.savedOrderby||null);var j=c.pageSize||40,k=this;this._private={ready:!1,owner:this,queryString:b,savedQuery:f,orderby:i,savedOrderby:i,dataURI:c.dataURI,pageSize:j,withQueryPlan:c.queryPlan,withQueryPath:c.queryPath,progressInfo:c.progressInfo,params:c.params,dataClass:a,methodRefs:a._private.entityCollectionMethodRefs,methods:a._private.entityCollectionMethods,autoExpand:c.autoExpand,autoSubExpand:c.autoSubExpand,filterAttributes:c.filterAttributes,isMethodResult:c.isMethodResult,isARelatedEntityCollection:c.isARelatedEntityCollection,loadedElemsLength:0,addedElems:[],curPendingStamp:0,pendingRequests:{},pages:[],clearCache:g.EntityCollection.clearCache,insertPage:g.EntityCollection.insertPage,findPage:g.EntityCollection.findPage,invalidPage:g.EntityCollection.invalidPage,getKeyByPos:g.EntityCollection.getKeyByPos,manageData:g.EntityCollection.manageData,fetchData:g.EntityCollection.fetchData,addPendingRequest:g.EntityCollection.addPendingRequest,clearPendingRequest:g.EntityCollection.clearPendingRequest,clearAllPendingRequest:g.EntityCollection.clearAllPendingRequest,isPagePending:g.EntityCollection.isPagePending,gotEntity:g.EntityCollection.gotEntity,updateOptions:g.EntityCollection.updateOptions};var l=this._private,m=l.methods;for(var n in m)k[n]=m[n];return this.length=0,c.init=!0,c.createEmptyCollection?(l.ready=!0,b="*"):null!=c.dataURI&&"*"==c.dataURI?l.ready=!0:null!=c.prefetchedData?k._private.manageData(c.prefetchedData,!0):(null==b&&null==l.savedQuery&&(l.savedQuery="$all"),k._private.fetchData(0,j,c,d)),k},g.EntityCollection.clearCache=function(){var a=this;a.pages=[]},g.EntityCollection.insertPage=function(a){var b=this,c=b.pages,d=c.length;if(0==d)c.push(a);else{for(var e=-1,f=0;d>f;f++){var g=c[f];if(g.start>a.start){e=f;break}}-1==e?c.push(a):c.splice(e,0,a)}},g.EntityCollection.findPage=function(a){for(var b=this,c=b.pages,d=c.length,e=0,f=d;f>e;){var g=Math.floor((f-e)/2)+e,h=c[g];if(h.start<=a&&h.start+h.length>a)return g;a<h.start?f=g:e=g+1}return-1},g.EntityCollection.invalidPage=function(a){var b=this,c=b.findPage(a);-1!=c&&b.pages.splice(c,1)},g.EntityCollection.getKeyByPos=function(a){var b=null,c=this,d=c.findPage(a);if(-1!=d){var e=c.pages[d],f=e.entityKeys[a-e.start];b=f.key}return b},g.EntityCollection.addPendingRequest=function(a,b){var c=this;return c.curPendingStamp++,c.pendingRequests[c.curPendingStamp]={start:a,length:b},c.curPendingStamp},g.EntityCollection.clearPendingRequest=function(a){var b=this;delete b.pendingRequests[a]},g.EntityCollection.clearAllPendingRequest=function(){var a=this;for(var b in a.pendingRequests)a.pendingRequests[b]},g.EntityCollection.isPagePending=function(a){var b=this;for(var c in b.pendingRequests){var d=b.pendingRequests[c];if(d.start<=a&&d.start+d.length>a)return!0}return!1},g.EntityCollection.manageData=function(a,b){var c,d=this,e=this.owner,f=e.getDataClass();b=b||!1,b&&(e.length=a.__COUNT,d.ready=!0,d.loadedElemsLength=e.length,d.dataURI=a.__ENTITYSET,null!=d.autoSubExpand&&(d.autoExpand=d.autoSubExpand,d.autoSubExpand=null));var h=a.__SENT,i=a.__FIRST,j=a.__ENTITIES,k=new Date,l=new g.EntityCollectionPage(i,h),m=f.mustCacheRef();c=m?f.getRefCache():f.getCache(),c.makeRoomFor(h);for(var n=0;h>n;n++){var o,p=j[n];if(null==p)m||c.setEntry("",{__STAMP:0},k),o="";else{var q=-1;if(o=p.__KEY,null==o&&(o=""),m){new g.Entity(f,p,{getRefFromCache:!0})}else q=c.setEntry(o,p,k)}l.entityKeys.push({key:p.__KEY,stamp:q})}d.insertPage(l)},g.EntityCollection.fetchData=function(a,b,c,d){var e=g.tools.handleArgs(arguments,2);d=e.userData,c=e.options;var f=c.filterSet,h=c.init||!1,i=this,j=this.owner,k=j.getDataClass(),l=(k.getCache(),i.addPendingRequest(a,b)),m=new g.core.restConnect.restRequest(!0);if(m.entityCollection=j,m.resource=i.dataClass.getNameForRest(),null!=f?null!=f._private.dataURI?(m.dataURI=f._private.dataURI,m.filter=i.queryString):m.filter=i.savedQuery:m.filter=i.queryString,m.top=b,m.skip=a,m.attributesRequested=null,m.attributesExpanded=null,m.autoExpand=i.autoExpand,m.autoSubExpand=i.autoSubExpand,m.filterAttributes=i.filterAttributes,m.params=i.params,i.mustRefreshCollectionOnNextFetch&&(m.refreshOnly=!0,i.mustRefreshCollectionOnNextFetch=!1),c.fromSelection&&(m.fromSelection=c.fromSelection),h){m.removeAtPos=c.removeAtPos,m.removeReferenceOnly=c.removeReferenceOnly,m.addToSet=c.addToSet;var n=m.fromSelection;null!=n&&(m.fromSelection=n.prepareToSend())}m.queryPlan=i.withQueryPlan,m.progressInfo=i.progressInfo,i.isARelatedEntityCollection?m.method="subentityset":m.method="entityset",m.timeout=c.timeout||300,m.savedOrderby=i.savedOrderby,m.savedQueryString=i.savedQuery,m.dataURI=m.dataURI||i.dataURI,m.dataURI&&null==f&&(m.filter=null),m.orderby=c.orderby,m.subOrderby=c.subOrderby,m.keepSelection=c.keepSelection,m.reselect=c.reselect,m.handler=function(){if(4==m.http_request.readyState){i.clearPendingRequest(l);var a=g.getRequestResult(m),b={entityCollection:j,result:j,XHR:m.http_request},e=null!=a.__ERROR;e||(null!=a.__transformedSelection&&(b.transformedSelection=a.__transformedSelection),i.manageData(a,h)),g.callHandler(e,a.__ERROR,b,c,d)}};m.go()},g.EntityCollection.updateOptions=function(a){var b=this;if(b.addedElems.length>0){for(var c=[],d=0,e=b.addedElems.length;e>d;d++){var f=b.addedElems[d],g=null;null!=f&&f.getKey&&(g=f.getKey()),null!=g&&c.push(g)}c.length>0&&(a.addToSet=c)}},g.EntityCollection.getDataClass=function(){var a=this;return a._private.dataClass},g.EntityCollection.getReference=function(){
var a=null,b=this,c=b._private;return null!=c.dataURI&&(a={dataURI:c.dataURI},null!=c.savedQuery&&(a.savedQuery=c.savedQuery),null!=c.savedOrderby&&(a.savedOrderby=c.savedOrderby),null!=c.pageSize&&(a.pageSize=c.pageSize),null!=c.autoExpand&&(a.autoExpand=c.autoExpand)),a},g.EntityCollection.query=function(a,b,c){var d=g.tools.handleArgs(arguments,1,{queryParams:!0});c=d.userData,b=d.options;var e=this;b.filterSet=e;var f=e.getDataClass();b.pageSize=b.pageSize||e._private.pageSize,b.autoExpand=b.autoExpand||e._private.autoExpand,b.filterAttributes=b.filterAttributes||e._private.filterAttributes,e._private.updateOptions(b);var h=new g.EntityCollection(f,a,b,c);return h},g.EntityCollection.orderBy=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this;if(0==this.length){var f={entityCollection:e,result:e};return g.callHandler(!1,null,f,b,c),e}b.orderby=a;var h=e._private;b.dataURI=h.dataURI;var i=e.getDataClass();b.pageSize=b.pageSize||h.pageSize,b.autoExpand=b.autoExpand||h.autoExpand,b.filterAttributes=b.filterAttributes||h.filterAttributes,h.updateOptions(b),b.savedQuery=h.savedQuery||null;var j=new g.EntityCollection(i,null,b,c);return j},g.EntityCollection.getEntities=function(a,b,c,d){var e=this,f=e._private;if(f.ready){a+b>e.length&&(b=e.length-a);var h=g.tools.handleArgs(arguments,2);d=h.userData,c=h.options;f.loadedElemsLength,f.addedElems.length,e.getDataClass();f.updateOptions(c);var i=[],j={entityCollection:e,result:e,position:a,howMany:b,entities:i},k=null;e.forEach({first:a,limit:a+b,onSuccess:function(a){i.push(a.entity)},onError:function(a){k=a.error},atTheEnd:function(a){null!=k?g.callHandler(!0,k,j,c,d):g.callHandler(!1,null,j,c,d)}})}else setTimeout(function(){e.getEntities(a,b,c,d)},100)},g.EntityCollection.getEntity=function(a,b,c,d){var e=!1,f=g.tools.handleArgs(arguments,1);c=f.userData,b=f.options;var h=null!=b&&(b.forceCollectionRefresh||!1);d=f.nextParam<arguments.length?arguments[f.nextParam]||!1:!1;var i=this,j=i._private,k=j.loadedElemsLength;h&&(j.clearAllPendingRequest(),j.clearCache(),j.mustRefreshCollectionOnNextFetch=!0,k=i.length);var l=i.getDataClass();if(a>=k){e=!0;var m={entityCollection:i,result:i,position:a},n=a-j.loadedElemsLength;n<j.addedElems.length?(m.entity=j.addedElems[n],g.callHandler(!1,null,m,b,c)):h?g.callHandler(!1,null,m,b,c):g.callHandler(!0,[{error:501,message:"wrong position in entityCollection"}],m,b,c)}else{var o=!1,p=j.getKeyByPos(a);if(null!=p||d||(j.isPagePending(a)?setTimeout(function(){i.getEntity(a,b,c)},100):o=!0),null!=p){var q,r=l.mustCacheRef();q=r?l.getRefCache():l.getCache();var s=q.getCacheInfo(p);null!=s?(e=!0,j.gotEntity(s,b,c,a)):(o=!0,p=null,j.invalidPage(a))}if(d&&(o=!1),null==p&&o){var t,u;if(null!=b?(t=b.delay,u=b.delayInfo):(t=null,u=null),null!=t&&0!=t&&null!=u){var v=u.findMatchingPendingRequest(a);if(null==v){var w=a-20;0>w&&(w=0),v=u.addPendingRequest(0,w,a+j.pageSize-1),v.addFetchRequest(a,b,c);var x=setTimeout(function(){if(v.matchRange(u.top,u.bottom)){var a={};h&&j.updateOptions(a),j.fetchData(v.top,v.bottom-v.top+1,{onSuccess:function(a){h&&(j.addedElems=[]),v.pendingFetch.forEach(function(a){if(a.pos>=u.top&&a.pos<=u.bottom){var b,c=j.getKeyByPos(a.pos),d=l.mustCacheRef();b=d?l.getRefCache():l.getCache();var e=b.getCacheInfo(c);null!=e?j.gotEntity(e,a.options,a.userData,a.pos):j.gotEntity(null,a.options,a.userData)}}),u.removePendingRequest(v)},onError:function(a){v.pendingFetch.forEach(function(b){if(b.pos>=u.top&&b.pos<=u.bottom){var c={entityCollection:i,result:i,position:b.pos,entity:null};g.callHandler(!0,a.error,c,b.options,b.userData)}}),u.removePendingRequest(v)},init:h,addToSet:a.addToSet||null})}else u.removePendingRequest(v)},t);v.setRequestID(x)}else v.addFetchRequest(a,b,c)}else{var y={};h&&j.updateOptions(y),j.fetchData(a,j.pageSize,{onSuccess:function(d){h&&(j.addedElems=[]);var e,f=j.getKeyByPos(a),g=l.mustCacheRef();e=g?l.getRefCache():l.getCache();var i=e.getCacheInfo(f);null!=i?j.gotEntity(i,b,c,a):j.gotEntity(null,b,c)},onError:function(d){var e={entityCollection:i,result:i,position:a,entity:null};g.callHandler(!0,d.error,e,b,c)},init:h,addToSet:y.addToSet||null})}}}return e},g.EntityCollection.gotEntity=function(a,b,c,d){var e,f=this,h=f.owner;e=null!=a?null!=a.entity?a.entity:new g.Entity(h.getDataClass(),a.rawEntity,{getRefFromCache:!0}):null;var i={entityCollection:h,result:e,entity:e,position:d};g.callHandler(!1,null,i,b,c)},g.EntityCollection.callMethod=function(a){var b=this,c=b._private.methodRefs[a.method];if(null!=c){var d=[];if(null!=a.arguments)d=a.arguments;else for(var e=1,f=arguments.length;f>e;e++)d.push(arguments[e]);return g.DataStore.funcCaller(c,b,d,a)}},g.EntityCollection.parseForEach=function(a,b){for(var c=!0,d=b.entityCollection,e=(d._private,!1);c&&b.curelem<b.limit&&!e;)c=d.getEntity(b.curelem,a,b.userData,!0),null!=a&&a.mustStopLoop?e=!0:c?b.curelem++:d.getEntity(b.curelem,{onSuccess:function(c){g.EntityCollection.parseForEach(a,b)},onError:function(c){g.callHandler(!0,c.error,c,a,b.userData)}},b);if(c&&null!=a.atTheEnd){var f={entityCollection:d,userData:b.userData};a.atTheEnd(f)}return c},g.EntityCollection.forEach=function(a,b){var c=this,d=(c._private,g.tools.handleArgs(arguments,0,{with3funcs:!0}));b=d.userData,a=d.options;var e=c.length;null!=a.limit&&a.limit<e&&(e=a.limit);var f={curelem:a.first||0,limit:e,userData:b,entityCollection:c};g.EntityCollection.parseForEach(a,f)},g.EntityCollection.forEachInCache=function(a,b){var c=this,d=c._private,e=g.tools.handleArgs(arguments,0,{with3funcs:!0});b=e.userData,a=e.options;var f=!1,h=-1,i=d.pages.length,j=0,k=0,l=null,m=0,n=a.first||0,o=c.length;for(null!=a.limit&&a.limit<o&&(o=a.limit);!f;)if(j>=k?(++h,h>=i?f=!0:(l=d.pages[h],k=l.length,j=0,m=l.start)):++j,!f){var p=m+j;p>=n&&(o>p?c.getEntity(p,a,b,!0):f=!0)}},g.EntityCollection.add=function(a){null!=a&&(this._private.addedElems.push(a),this.length++)},g.EntityCollection.refresh=function(a,b){a=a||{},a.forceCollectionRefresh=!0;var c=0;null!=a.refreshCollectionFrom&&(c=a.refreshCollectionFrom),b=b,this.getEntity(c,a,b)},g.EntityCollection.toArray=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,f=e._private;f.updateOptions(b);var h=new g.core.restConnect.restRequest(!0);h.entityCollection=e,h.resource=f.dataClass.getNameForRest(),h.top=b.top||f.pageSize||40,h.skip=b.skip||null,h.params=f.params,h.addToSet=b.addToSet,h.retainPositions=b.retainPositions||null,h.progressInfo=b.progressInfo||f.progressInfo,h.savedOrderby=f.savedOrderby,h.savedQueryString=f.savedQuery,h.dataURI=f.dataURI,h.orderby=b.orderby,h.autoExpand=a,h.asArray=!0,b.filterQuery&&(h.filter=b.filterQuery,h.params=b.params),h.handler=function(){if(4==h.http_request.readyState){var a=g.getRequestResult(h),d={entityCollection:e,result:a,XHR:h.http_request},f=null!=a.__ERROR;g.callHandler(f,a.__ERROR,d,b,c)}};h.go()},g.EntityCollection.distinctValues=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,f=e._private;f.updateOptions(b);var h=new g.core.restConnect.restRequest(!0);h.entityCollection=e,h.resource=f.dataClass.getNameForRest(),h.addToSet=b.addToSet,h.top=b.top||null,h.skip=b.skip||null,h.params=f.params,h.progressInfo=b.progressInfo||f.progressInfo,h.savedOrderby=f.savedOrderby,h.savedQueryString=f.savedQuery,h.dataURI=f.dataURI,h.distinct=!0,null!=a&&(h.attributesRequested=[a]),h.handler=function(){if(4==h.http_request.readyState){var a=g.getRequestResult(h),d={entityCollection:e,distinctValues:a,result:a,XHR:h.http_request},f=null!=a.__ERROR;g.callHandler(f,a.__ERROR,d,b,c)}};h.go()},g.EntityCollection.findKey=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,f=e._private;f.updateOptions(b);var h=new g.core.restConnect.restRequest(!0);h.entityCollection=e,h.resource=f.dataClass.getNameForRest(),h.addToSet=b.addToSet,h.top=b.top||null,h.skip=b.skip||null,h.params=f.params,h.progressInfo=b.progressInfo||f.progressInfo,h.savedOrderby=f.savedOrderby,h.savedQueryString=f.savedQuery,h.dataURI=f.dataURI,a instanceof Date&&(a=a.toISO()),h.findKey=a,h.handler=function(){if(4==h.http_request.readyState){var a=g.getRequestResult(h),d={entityCollection:e,result:a.result,XHR:h.http_request},f=null!=a.__ERROR;g.callHandler(f,a.__ERROR,d,b,c)}};h.go()},g.EntityCollection.removeEntityReference=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options,b.removeReferenceOnly=!0,this.removeEntity(a,b,c)},g.EntityCollection.removeEntity=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,f=e._private;b.dataURI=f.dataURI;var h=e.getDataClass();if(!(a>=f.loadedElemsLength&&a<e.length)){b.pageSize=b.pageSize||f.pageSize,b.autoExpand=b.autoExpand||f.autoExpand,b.filterAttributes=b.filterAttributes||f.filterAttributes,f.updateOptions(b),b.removeAtPos=a,b.savedQuery=f.savedQuery||null,b.savedOrderby=f.savedOrderby||null;var i=new g.EntityCollection(h,null,b,c);return i}var j=a-f.loadedElemsLength,k=f.addedElems[j],l={entityCollection:e,result:e};null==k||null==k.getKey()||b.removeReferenceOnly?(f.addedElems.splice(j,1),e.length--,g.callHandler(!1,null,l,b,c)):k.remove({onSuccess:function(a){f.addedElems.splice(j,1),e.length--,g.callHandler(!1,null,l,b,c)},onError:function(a){g.callHandler(!0,a.error,l,b,c)}})},g.EntityCollection.removeAllEntities=function(a,b){var c=g.tools.handleArgs(arguments,0);b=c.userData,a=c.options;var d=this,e=d._private;e.updateOptions(a);var f=new g.core.restConnect.restRequest(!0);f.entityCollection=d,f.resource=e.dataClass.getNameForRest(),f.addToSet=a.addToSet,f.params=e.params,f.progressInfo=a.progressInfo||e.progressInfo,f.savedOrderby=e.savedOrderby,f.savedQueryString=e.savedQuery,f.dataURI=e.dataURI,f.method="delete",f.atOnce=a.atOnce,f.handler=function(){if(4==f.http_request.readyState){var c=g.getRequestResult(f),e={entityCollection:d,XHR:f.http_request},h=null!=c.__ERROR;g.callHandler(h,c.__ERROR,e,a,b)}};f.go()},g.EntityCollection.buildFromSelection=function(a,b,c){var d=g.tools.handleArgs(arguments,1);c=d.userData,b=d.options;var e=this,f=e._private,h=e.getDataClass();b.pageSize=b.pageSize||f.pageSize,b.autoExpand=b.autoExpand||f.autoExpand,b.filterAttributes=b.filterAttributes||f.filterAttributes,f.updateOptions(b),b.filterSet=e,b.fromSelection=a,b.savedQuery=f.savedQuery||null,b.savedOrderby=f.savedOrderby||null;var i=new g.EntityCollection(h,null,b,c);return i},g.EntityAttributeSimple=function(a,b,e){this.owner=a,"date"===e.type&&"string"==typeof b?e.simpleDate?this.value=d(b):this.value=c(b):this.value=b,("blob"===e.type||"image"===e.type)&&(e.unResolvedFile=null,e.resolvedID=null),this.touched=!1,this.att=e,this.getValue=g.EntityAttributeSimple.getValue,this.setValue=g.EntityAttributeSimple.setValue,this.touch=g.EntityAttributeSimple.touch,this.isTouched=g.EntityAttributeSimple.isTouched,this.clearTouched=g.EntityAttributeSimple.clearTouched,this.getOldValue=g.EntityAttributeSimple.getOldValue,this.setRawValue=g.EntityAttributeSimple.setRawValue,this.getRawValue=g.EntityAttributeSimple.getRawValue,this.resolveFile=g.EntityAttributeSimple.resolveFile},g.EntityAttributeSimple.getValue=function(){return this.value},g.EntityAttributeSimple.setValue=function(a){"blob"===this.att.type||"image"===this.att.type?(this.unResolvedFile=a,this.resolvedID=null,this.touch()):(void 0===this.oldValue&&(this.oldValue=this.value),this.value=a,this.touch())},g.EntityAttributeSimple.resolveFile=function(a,b){var c=this,d=g.tools.handleArgs(arguments,0);if(b=d.userData,a=d.options,null!=this.unResolvedFile){var e=new g.core.restConnect.restRequest(!0);e.resource="$upload",e.httpMethod=g.core.restConnect.httpMethods._post,e.postdata=this.unResolvedFile,e.postAFile=!0,e.handler=function(){if(4==e.http_request.readyState){var d=!1,f=null,h=g.getRequestResult(e),i=null;null!=h.__ERROR?(d=!0,f=h.__ERROR):(i=h,null!=h.ID&&(c.unResolvedFile=null,c.resolvedID=h.ID));var j={result:i};g.callHandler(d,f,j,a,b)}},e.go()}else{var f={result:null};g.callHandler(!0,{error:602,errorMessage:"no file to resolve"},f,a,b)}},g.EntityAttributeSimple.touch=function(){this.touched=!0,this.owner.touch()},g.EntityAttributeSimple.clearTouched=function(){this.touched=!1},g.EntityAttributeSimple.isTouched=function(){return this.touched},g.EntityAttributeSimple.getOldValue=function(){return void 0===this.oldValue?this.getValue():this.oldValue},g.EntityAttributeSimple.setRawValue=function(a){"date"===this.att.type&&"string"==typeof a?this.att.simpleDate?this.value=d(a):this.value=c(a):this.value=a,("blob"===this.att.type||"image"===this.att.type)&&(this.unResolvedFile=null,this.resolvedID=null),delete this.oldValue},g.EntityAttributeSimple.getRawValue=function(){var a=this.value;return null!=this.resolvedID?a={ID:this.resolvedID}:null!=a&&"date"===this.att.type&&(a=this.att.simpleDate?a.toSimpleDateString():a.toISO()),a},g.EntityAttributeRelated=function(a,b,c){if(g.EntityAttributeSimple.call(this,a,b,c),null!=b)if(null!=b.__deferred)this.relEntity=null,this.dataURI=b.__deferred.uri,this.relKey=b.__deferred.__KEY;else{var d=c.getRelatedClass();null==d?(this.relEntity=null,this.dataURI=null,this.relKey=null):(this.relEntity=new g.Entity(d,b,{getRefFromCache:!0}),this.dataURI=null,this.relKey=null)}else this.relEntity=null,this.dataURI=null,this.relKey=null;this.setValue=g.EntityAttributeRelated.setValue,this.getValue=g.EntityAttributeRelated.getValue,this.load=this.getValue,this.setRawValue=g.EntityAttributeRelated.setRawValue,this.getRawValue=g.EntityAttributeRelated.getRawValue,this.getOldValue=g.EntityAttributeRelated.getOldValue,this.getRelatedKey=g.EntityAttributeRelated.getRelatedKey},g.EntityAttributeRelated.getRelatedKey=function(){var a=null;return a=null==this.relEntity?this.relKey:this.relEntity.getKey()},g.EntityAttributeRelated.getOldValue=function(){return void 0===this.oldValue?this.getValue():this.oldValue},g.EntityAttributeRelated.getValue=function(a,b){if(null==a)return this.relEntity;var c=g.tools.handleArgs(arguments,0);b=c.userData,a=c.options;var d=this,e={entity:null};if(null==d.relEntity)if(null==d.dataURI&&null==d.relKey)g.callHandler(!1,null,e,a,b);else{var f=d.att.getRelatedClass();null==f?g.callHandler(!1,null,e,a,b):null!=d.relKey?f.getEntity(d.relKey,{onSuccess:function(c){d.relEntity=c.entity,g.callHandler(!1,null,c,a,b)},onError:function(c){g.callHandler(!0,c.error,c,a,b)},autoExpand:a.autoExpand}):f.getEntityByURI(d.dataURI,{onSuccess:function(c){d.relEntity=c.entity,g.callHandler(!1,null,c,a,b)},onError:function(c){g.callHandler(!0,c.error,c,a,b)},autoExpand:a.autoExpand})}else e.entity=d.relEntity,g.callHandler(!1,null,e,a,b)},g.EntityAttributeRelated.setValue=function(a){void 0===this.oldValue&&(this.oldValue=this.relEntity),this.relEntity=a,this.touched=!0,this.owner.touch(),this.dataURI=null,null==a?this.relKey=null:a instanceof g.Entity?this.relKey=a.getKey():this.relKey!==a&&(this.relEntity=null,this.relKey=a)},g.EntityAttributeRelated.setRawValue=function(a){if(null!=a)if(null!=a.__deferred)this.relEntity=null,this.dataURI=a.__deferred.uri,this.relKey=a.__deferred.__KEY;else{var b=this.att.getRelatedClass();null==b?(this.relEntity=null,this.dataURI=null,this.relKey=null):(this.relEntity=new g.Entity(b,a,{getRefFromCache:!0}),this.dataURI=null,this.relKey=null)}else this.relEntity=null,this.dataURI=null,this.relKey=null;delete this.oldValue},g.EntityAttributeRelated.getRawValue=function(){var a=this.relKey;return this.relEntity&&(a=this.relEntity.getKey()),null!=a?{__KEY:a}:this.relEntity?this.relEntity._private.getRESTFormat():null},g.EntityAttributeRelatedSet=function(a,b,c){if(g.EntityAttributeSimple.call(this,a,b,c),null!=b)if(null!=b.__deferred)this.relEntityCollection=null,this.dataURI=b.__deferred.uri;else{var d=c.getRelatedClass();null==d?(this.relEntityCollection=null,this.dataURI=null):(this.relEntityCollection=new g.EntityCollection(d,null,{prefetchedData:b}),this.dataURI=this.relEntityCollection._private.dataURI)}else this.relEntityCollection=null,this.dataURI=null;this.setValue=g.EntityAttributeRelatedSet.setValue,this.getValue=g.EntityAttributeRelatedSet.getValue,this.setRawValue=g.EntityAttributeRelatedSet.setRawValue},g.EntityAttributeRelatedSet.setRawValue=function(a){if(null!=a)if(null!=this.dataURI&&a.__deferred==this.dataURI);else if(null!=a.__deferred)this.relEntityCollection=null,this.dataURI=a.__deferred.uri;else{var b=this.att.getRelatedClass();null==b?(this.relEntityCollection=null,this.dataURI=null):(this.relEntityCollection=new g.EntityCollection(b,null,{prefetchedData:a}),this.dataURI=this.relEntityCollection._private.dataURI)}else this.relEntityCollection=null,this.dataURI=null},g.EntityAttributeRelatedSet.getValue=function(a,b){if(null==a)return this.relEntityCollection;var c=g.tools.handleArgs(arguments,0);b=c.userData,a=c.options;var d=null,e={entityCollection:null};if(null!=this.relEntityCollection)if(d=this.relEntityCollection,d._private.ready)e.entityCollection=d,g.callHandler(!1,null,e,a,b);else{var f=function(){d._private.ready?(e.entityCollection=d,g.callHandler(!1,null,e,a,b)):setTimeout(f,100)};setTimeout(f,100)}else{var h=this.att.getRelatedClass();null==h?g.callHandler(!0,{error:601,errorMessage:"wrong entityCollection reference"},e,a,b):(null==this.dataURI&&(this.dataURI="*"),a.isARelatedEntityCollection=!0,a.dataURI=this.dataURI,this.relEntityCollection=new g.EntityCollection(h,null,a,b),d=this.relEntityCollection)}return d},g.Entity=function(a,b,c){var d=this;c=c||{};var e,f,h=(c.getRefFromCache||!1)&&a.mustCacheRef(),i=h&&null!=b,j=null;if(h&&null!=b&&(e=a.getRefCache(),f=b.__KEY,null!=f&&(j=e.getCacheInfo(f),null!=j&&b.__STAMP===j.entity.getStamp()))){if(j.timeStamp=new Date,d=j.entity,i){var k=a._private.attributesByName;for(var l in k){var m=k[l],n=b[l];void 0!=n&&(s=d[l],m.related?m.relatedOne?null!=n&&null==n.__deferred&&s.setRawValue(n):null!=n&&null==n.__deferred&&s.setRawValue(n):s.setRawValue(n))}}return d}this._private={touched:!1,isNew:!0,dataClass:a,owner:this,values:{},methodRefs:a._private.entityMethodRefs,methods:a._private.entityMethods,getRESTFormat:g.Entity.getRESTFormat,getListOfUnresolvedIDs:g.Entity.getListOfUnresolvedIDs};var o=this._private,p=o.methods;for(var l in p)d[l]=p[l];this.touch=g.Entity.touch,this.getDataClass=g.Entity.getDataClass,this.getKey=g.Entity.getKey,this.setStamp=g.Entity.setStamp,this.setKey=g.Entity.setKey,this.getStamp=g.Entity.getStamp,this.callMethod=g.Entity.callMethod,this.isNew=g.Entity.isNew,this.isTouched=g.Entity.isTouched,this.save=g.Entity.save,this.remove=g.Entity.remove,this.lock=g.Entity.lock,this.unlock=g.Entity.unlock,this._dolock=g.Entity._dolock,this.serverRefresh=g.Entity.serverRefresh;var q=!1;null==b||null==b.__KEY?(this._private.key=null,this._private.stamp=0,this._private.isNew=!0,q=!0,null!=b&&(this._private.touched=!0)):(this._private.key=b.__KEY,this._private.stamp=b.__STAMP,this._private.isNew=!1);var r=d._private.values,k=a._private.attributesByName;for(var l in k){var s,m=k[l],n=null==b?null:null==b[l]?null:b[l];s=m.related?m.relatedOne?new g.EntityAttributeRelated(d,n,m):new g.EntityAttributeRelatedSet(d,n,m):new g.EntityAttributeSimple(d,n,m),q&&null!=n&&(s.touched=!0),r[l]=s,d[l]=s}return h&&null!=b&&(e.setEntry(d),null!=j)?j.entity:void 0},g.Entity.getRESTFormat=function(a){var b=this,c=this.owner,d={},e=c.getKey();null!=e?(d.__KEY=e,d.__STAMP=c.getStamp(),a&&(d.__STAMP=-d.__STAMP)):d.__ISNEW=!0;for(var f in b.values){var g=b.values[f];g.isTouched()&&(d[f]=g.getRawValue())}return d},g.Entity.getListOfUnresolvedIDs=function(){var a=this,b=(this.owner,[]);for(var c in a.values){var d=a.values[c];d.isTouched()&&null!=d.unResolvedFile&&b.push(c)}return b},g.Entity.touch=function(){this._private.touched=!0},g.Entity.getDataClass=function(){return this._private.dataClass},g.Entity.getKey=function(){return this._private.key},g.Entity.getStamp=function(){return this._private.stamp},g.Entity.setKey=function(a){this._private.key=a},g.Entity.setStamp=function(a){this._private.stamp=a},g.Entity.callMethod=function(a){var b=this,c=b._private.methodRefs[a.method];if(null!=c){var d=[];if(null!=a.arguments)d=a.arguments;else for(var e=1,f=arguments.length;f>e;e++)d.push(arguments[e]);return g.DataStore.funcCaller(c,b,d,a)}},g.Entity.isNew=function(){return this._private.isNew},g.Entity.isTouched=function(){return this._private.touched},g.Entity.serverRefresh=function(a,b){var c=g.tools.handleArgs(arguments,0);b=c.userData,a=c.options,a.refreshOnly=!0,this.save(a,b)},g.Entity.lock=function(a,b){this._dolock(!0,a||null,b||null)},g.Entity.unlock=function(a,b){this._dolock(!1,a||null,b||null)},g.Entity._dolock=function(a,b,c){var d=this,e=g.tools.handleArgs(arguments,1);userData=e.userData,b=e.options;var f=d.getDataClass(),h=f.getNameForRest(),i=d.getKey(),j=new g.core.restConnect.restRequest(!0);j.resource=h+"("+i+")",j.mustlock=a,j.handler=function(){if(4==j.http_request.readyState){var a=!1,c=!1,e=null,f=g.getRequestResult(j);null!=f.__ERROR?(c=!0,e=f.__ERROR):a=f.result;var h={entity:d,result:a};g.callHandler(c,e,h,b,userData)}};j.go()},g.Entity.remove=function(a,b){var c=this,d=g.tools.handleArgs(arguments,0);b=d.userData,a=d.options;var e=c.getDataClass(),f=e.getNameForRest(),h=c.getKey(),i=new g.core.restConnect.restRequest(!0);i.resource=f+"("+h+")",i.method="delete",i.handler=function(){if(4==i.http_request.readyState){var d=!1,f=null,j=g.getRequestResult(i);null!=j.__ERROR?(d=!0,f=j.__ERROR):e.getCache().removeCachedEntity(h);var k={entity:c};g.callHandler(d,f,k,a,b)}};i.go()},g.Entity.save=function(a,b){function c(){if(l>=k.length)d();else{var f=k[l];e[f].resolveFile({onSuccess:function(a){++l,c()},onError:function(c){var d={entity:e,rawResult:null,XHR:null};g.callHandler(!0,c.error,d,a,b)}})}}function d(){var c=new g.core.restConnect.restRequest(!0);c.resource=i;var d=e.getKey();null==d?(c.method="update",c.httpMethod=g.core.restConnect.httpMethods._post):(c.method="update",c.httpMethod=g.core.restConnect.httpMethods._post),c.postdata='{ "__ENTITIES": ['+JSON.stringify(e._private.getRESTFormat(a.overrideStamp))+"]}",c.refreshOnly=j,null!=a.autoExpand&&(c.autoExpand=a.autoExpand),null!=a.filterAttributes&&(c.filterAttributes=a.filterAttributes),c.handler=function(){if(4==c.http_request.readyState){var d=g.getRequestResult(c),f={entity:e,rawResult:d,XHR:c.http_request},d=JSON.parse(c.http_request.responseText),i=!1,k=null;if(d&&d.__ENTITIES&&d.__ENTITIES[0]){var l=d.__ENTITIES[0];if(l.__ERROR)k=l.__ERROR,i=!0;else{var m=l.__KEY;j||(null!=m&&(e._private.key=m),e._private.stamp=l.__STAMP);var n=h._private.attributesByName;for(var o in n){var p=n[o],q=l[o];void 0===q&&(q=null);var r=e[o];null==r?(r=p.related?p.relatedOne?new g.EntityAttributeRelated(e,q,p):new g.EntityAttributeRelatedSet(e,q,p):new g.EntityAttributeSimple(e,q,p),e[o]=r):(r.setRawValue(q),j||r.clearTouched())}h.mustCacheRef()?h.getRefCache().setEntry(e):h.getCache().replaceCachedEntity(m,l),j||(e._private.touched=!1,e._private.isNew=!1)}}g.callHandler(i,k,f,a,b)}};c.go()}var e=this,f=g.tools.handleArgs(arguments,0);b=f.userData,a=f.options;var h=e.getDataClass(),i=h.getNameForRest(),j=a.refreshOnly;null==j&&(j=!1);var k=e._private.getListOfUnresolvedIDs(),l=0;c()},g.EntityCollection.prototype.getDataClass=g.EntityCollection.getDataClass,g.EntityCollection.prototype.query=g.EntityCollection.query,g.EntityCollection.prototype.getEntity=g.EntityCollection.getEntity,g.EntityCollection.prototype.getEntities=g.EntityCollection.getEntities,g.EntityCollection.prototype.callMethod=g.EntityCollection.callMethod,g.EntityCollection.prototype.each=g.EntityCollection.forEach,g.EntityCollection.prototype.forEach=g.EntityCollection.forEach,g.EntityCollection.prototype.forEachInCache=g.EntityCollection.forEachInCache,g.EntityCollection.prototype.add=g.EntityCollection.add,g.EntityCollection.prototype.orderBy=g.EntityCollection.orderBy,g.EntityCollection.prototype.toArray=g.EntityCollection.toArray,g.EntityCollection.prototype.distinctValues=g.EntityCollection.distinctValues,g.EntityCollection.prototype.findKey=g.EntityCollection.findKey,g.EntityCollection.prototype.removeEntity=g.EntityCollection.removeEntity,g.EntityCollection.prototype.removeEntityReference=g.EntityCollection.removeEntityReference,g.EntityCollection.prototype.removeAllEntities=g.EntityCollection.removeAllEntities,g.EntityCollection.prototype.buildFromSelection=g.EntityCollection.buildFromSelection,g.EntityCollection.prototype.getReference=g.EntityCollection.getReference,g.EntityCollection.prototype.refresh=g.EntityCollection.refresh,g.DataClass.prototype.distinctValues=g.DataClass.distinctValues,g.DataClass.prototype.all=g.DataClass.allEntities,g.DataClass.prototype.allEntities=g.DataClass.allEntities,g.DataClass.prototype.query=g.DataClass.query,g.DataClass.prototype.find=g.DataClass.find,g.DataClass.prototype.getAttributeByName=g.DataClass.getAttributeByName,g.DataClass.prototype.getAttributes=g.DataClass.getAttributes,g.DataClass.prototype.getMethodList=g.DataClass.getMethodList,g.DataClass.prototype.getCache=g.DataClass.getCache,g.DataClass.prototype.getRefCache=g.DataClass.getRefCache,g.DataClass.prototype.getCacheSize=g.DataClass.getCacheSize,g.DataClass.prototype.setCacheSize=g.DataClass.setCacheSize,g.DataClass.prototype.clearCache=g.DataClass.clearCache,g.DataClass.prototype.newEntity=g.DataClass.newEntity,g.DataClass.prototype.getEntity=g.DataClass.getEntity,g.DataClass.prototype.getEntityByURI=g.DataClass.getEntityByURI,g.DataClass.prototype.getDataStore=g.DataClass.getDataStore,g.DataClass.prototype.getCollectionName=g.DataClass.getCollectionName,g.DataClass.prototype.getDefaultTopSize=g.DataClass.getDefaultTopSize,g.DataClass.prototype.getName=g.DataClass.getName,g.DataClass.prototype.getNameForRest=g.DataClass.getNameForRest,g.DataClass.prototype.newCollection=g.DataClass.newCollection,g.DataClass.prototype.toArray=g.DataClass.toArray,g.DataClass.prototype.mustCacheRef=g.DataClass.mustCacheRef,g.DataClass.prototype.callMethod=g.DataStore.callMethod,g.directory=g.directory||{},g.directory.login=g.DataStore.makeFuncCaller({name:"login",applyTo:"general",nameSpace:"$directory"}),g.directory.loginByPassword=g.directory.login,g.directory.logout=g.DataStore.makeFuncCaller({name:"logout",applyTo:"general",nameSpace:"$directory"}),g.directory.loginByKey=g.DataStore.makeFuncCaller({name:"loginByKey",applyTo:"general",nameSpace:"$directory"}),g.directory.currentUser=g.DataStore.makeFuncCaller({name:"currentUser",applyTo:"general",nameSpace:"$directory"}),g.directory.currentUserBelongsTo=g.DataStore.makeFuncCaller({name:"currentUserBelongsTo",applyTo:"general",nameSpace:"$directory"}),g.dsExport=g.dsExport||{},g.dsExport.exportData=g.DataStore.makeFuncCaller({name:"exportData",applyTo:"general",nameSpace:"$impexp"});var h=angular.module("wakanda",[]);h.provider("$wakandaConfig",function(){var a="";this.$get=function(){return{getHostname:function(){return a}}},this.setHostname=function(b){g.hostname=b,a=b}}),h.factory("$wakanda",["$q","$rootScope","$http","$wakandaConfig",function(a,b,c,d){function e(){var b,c=Array.prototype.slice.call(arguments),d=c.shift(),e={};return b=a.defer(),b.promise.$promise=b.promise,e.onSuccess=function(a){b.resolve({result:a.result})},e.onError=function(a){b.reject(a)},c.push(e),d.apply(this,c),b.promise}function h(a,b){var c=a.$_entity.getDataClass();if("relatedEntity"===c.getAttributeByName(b).kind&&a.$_entity&&a.$_entity[b]){if(a._related||Object.defineProperty(a,"_related",{value:{},enumerable:!1,writable:!0,configurable:!0}),!a._related[b])if(a.$_entity[b].relEntity){var d=a.$_entity[b].relEntity;a._related[b]=new(k[d.getDataClass().getName()])(d)}else c=a.$_entity[b].att.getRelatedClass(),a._related[b]=new(k[c.getName()])(c,a.$_entity[b].getRelatedKey());return a._related[b]}}function i(a,b){var c,d;return b=b||{},c=a.getDataClass().getName(),d=new k[c](a,b.key),b.expend?(d.$_dataClass.$_relatedAttributes.forEach(function(a){"relatedEntity"===a.kind&&d.$_entity[a.name]&&h(d,a.name)}),d):d}var j=null,k={},l=40,m={};m.init=function(b){var c=a.defer();return c.promise.$promise=c.promise,("string"!=typeof b||"*"===b||""===b)&&(b=null),null===j?new g.DataStore({onSuccess:function(a){j=a.dataStore,o.wafDatastore(j),o.wafDataClasses(j),c.resolve(j)},onError:function(a){j=null,c.reject(a)},catalog:b,cacheRef:!1}):c.resolve(j),c.promise},m.getDatastore=function(){if(null!==j)return j;throw new Error("The Datastore isn't initialized please execute .init(catalog) before you run your app.")},Object.defineProperty(m,"$ds",{get:m.getDatastore}),m.$loginByPassword=m.$login=function(a,b){return e(g.directory.loginByPassword,a,b)},m.$currentUser=function(){return e(g.directory.currentUser)},m.$logout=function(){return e(g.directory.logout)},m.$currentUserBelongsTo=function(a){return e(g.directory.currentUserBelongsTo,a)},m.$transform={$objectToEntity:i,$objectToCollection:function(a,b){var c=[];return q.wafEntityCollectionToNgWakEntityCollection(c,a,b),c}};var n=function(a){var c=b.$$phase;"$apply"===c||"$digest"===c?a&&"function"==typeof a&&a():b.$apply(a)},o={wafDatastore:function(a){a.$Entity=E.prototype},wafDataClasses:function(a){var b;g.DataClass.prototype.$query=A,g.DataClass.prototype.$find=C,g.DataClass.prototype.$create=r,g.DataClass.prototype.$all=B;for(b in a)a.hasOwnProperty(b)&&"_private"!==b&&"$"!==b[0]&&(o.wafDataClassAddMetas(a[b]),o.wafDataClassAddDataClassMethods(a[b]),o.wafDataClassCreateNgWakEntityClasses(a[b]))},wafDataClassAddMetas:function(a){var b,c,d=[],e=[],f=[];angular.forEach(a.getMethodList(),function(a){switch(a.applyTo){case"entity":f.push(a.name);break;case"entityCollection":e.push(a.name);break;case"dataClass":d.push(a.name)}}),b=a._private.attributesByName,a.$attr=function(a){return"undefined"==typeof a?b:a&&b[a]?b[a]:null},a.$dataClassMethods=function(){return d},a.$collectionMethods=function(){return e},a.$entityMethods=function(){return f},a.$name=a.getName(),a.$collectionName=a.getCollectionName();for(c in b)b[c].identifying===!0&&(a.$_identifyingAttr=b[c]);a.$_relatedAttributes=a.getAttributes().filter(function(a){return"relatedEntity"===a.kind||"relatedEntities"===a.kind?a:void 0}),a.$_processedAttributes=a.getAttributes().filter(function(a){return"calculated"===a.kind||"alias"===a.kind?a:void 0})},wafDataClassAddDataClassMethods:function(a){p.createUserDefinedDataClassMethods(a)},wafDataClassCreateNgWakEntityClasses:function(a){var b;b=p.createUserDefinedEntityMethods(a),k[a.getName()]=E.extend(b),a.$Entity=k[a.getName()].prototype}},p={createUserDefinedEntityMethods:function(a){var b,c={};for(b in a._private.entityMethods)a._private.entityMethods.hasOwnProperty(b)&&(c[b+"Sync"]=function(){return this.$_entity[b].apply(this.$_entity,arguments)},c[b]=p.wakandaUserDefinedMethodToPromisableMethods(a._private.entityMethods[b]));return c},createUserDefinedEntityCollectionMethods:function(a){var b,c={};for(b in a._private.entityCollectionMethods)a._private.entityCollectionMethods.hasOwnProperty(b)&&(c[b+"Sync"]=function(){return this.$_collection[b].apply(this.$_collection,arguments)},c[b]=p.wakandaUserDefinedMethodToPromisableMethods(a._private.entityCollectionMethods[b]));return c},createUserDefinedDataClassMethods:function(b){angular.forEach(b.$dataClassMethods(),function(c){b[c]=function(){var d=a.defer();return d.promise.$promise=d.promise,b.callMethod({method:c,onSuccess:function(a){d.resolve(a)},onError:function(a){d.reject(a)},arguments:arguments.length>0?Array.prototype.slice.call(arguments,0):[]}),d.promise},b[c+"Sync"]=function(){return b.callMethod({method:c,sync:!0,arguments:arguments.length>0?Array.prototype.slice.call(arguments,0):[]})}})},wakandaUserDefinedMethodToPromisableMethods:function(b){return function(){var c,d,e,f=[],h={};if(this instanceof E){if("undefined"==typeof this.$_entity||!(this.$_entity instanceof g.Entity))throw new Error("Calling user defined method on unfetched entity, please call $fetch before or retrieve data on $query");
d="$_entity"}else d="$_collection";if(arguments.length>0)for(var i=0;i<arguments.length;i++)f.push(arguments[i]);if(e=a.defer(),c=this,e.promise.$promise=e.promise,h.onSuccess=function(a){n(function(){e.resolve(a)})},h.onError=function(a){n(function(){e.reject(a)})},f.unshift(h),"$_entity"===d)b.apply(this[d],f);else{if(!this.$_collection)throw new Error("Couldn't call user defined method on collection because no pointer on this collection");b.apply(this[d],f)}return e.promise}}},q={wafEntityCollectionToNgWakEntityCollection:function(a,b,c){c="undefined"==typeof c?{}:c;var d=(b.getDataClass(),"undefined"==typeof c.start?0:c.start),e="undefined"==typeof c.pageSize?l:c.pageSize;"undefined"==typeof a.$_collection&&(a.$_collection=b,q.addFrameworkMethodsToRootCollection(a),q.addUserDefinedMethodsToCollection(a,!0)),b.forEachInCache({onSuccess:function(b){a.push(i(b.entity))},first:d,limit:d+e})},addUserDefinedMethodsToCollection:function(a,b){var c,d=null;if(b===!0?"undefined"!=typeof a.$_collection&&(d=a.$_collection.getDataClass()):b===!1&&"undefined"!=typeof a.$_collection&&"undefined"!==a.$_collection.relEntityCollection&&(d=a.$_collection.relEntityCollection),null===d)return a;c=p.createUserDefinedEntityCollectionMethods(d);for(var e in c)c.hasOwnProperty(e)&&(a[e]=c[e]);return a},addFrameworkMethodsToRootCollection:function(a){a.$fetch=u,a.$query=A.bind(a.$_collection),a.$all=B.bind(a.$_collection),a.$add=z,a.$more=w,a.$nextPage=x,a.$prevPage=y,a.$totalCount=a.$_collection.length,a.$toJSON=v},addFrameworkMethodsToNestedCollection:function(a){a.$fetch=F.bind(a),a.$query=A.bind(a.$_collection),a.$all=B.bind(a.$_collection),a.$more=w,a.$nextPage=x,a.$prevPage=y,a.$toJSON=v,a.$isLoaded=function(){return!!a.$_isLoaded},a.$totalCount=null},cleanNgWakEntityAfterSave:function(a){var b=a.$_entity.getDataClass().$_processedAttributes;b.length>0&&b.forEach(function(b){"undefined"!=typeof a.$_entity[b.name].$_tempValue&&delete a.$_entity[b.name].$_tempValue})}},r=function(a){var b,c={};for(b=0;b<this.$_relatedAttributes.length;b++){var d=this.$_relatedAttributes[b];a.hasOwnProperty(d.name)&&void 0!==a[d.name]&&(c[d.name]=a[d.name],delete a[d.name])}var e=i(new g.Entity(this,a||{}),{expend:!0}),f=Object.keys(c);for(b=0;b<f.length;b++)e[f[b]]=c[f];return e},s=function(a,b,c){"undefined"==typeof a.$queryParams&&(a.$queryParams={}),a.$queryParams.pageSize=b,a.$queryParams.start=c},t=function(a,b,c,d){"undefined"==typeof a.$queryParams&&(a.$queryParams={}),a.$queryParams.pageSize=b,a.$queryParams.start=c,a.$queryParams.filter=d?d:a.$queryParams.filter},u=function(b,c){var d,e,f,g={},h=this;if(c=c||"replace","replace"!==c&&"append"!==c)throw new Error("Unknow mode "+c+", mode must be replace or append.");if(b||(b={}),"undefined"!=typeof b.orderBy)throw new Error("orderBy can't be change on a $fetch (query collection's cached on server side)");if("undefined"!=typeof b.select)throw new Error("select can't be change on a $fetch (query collection's cached on server side)");return e=b.start="undefined"==typeof b.start?this.$queryParams.start:b.start,f=b.pageSize=b.pageSize||this.$queryParams.pageSize,b.params&&(g.params=b.params),Object.defineProperty(this,"$fetching",{enumerable:!1,writable:!0,configurable:!0}),d=a.defer(),d.promise.$promise=d.promise,h=this,n(function(){h.$fetching=!0}),g.onSuccess=function(a){n(function(){"replace"===c&&(h.length=0),a.entities.forEach(function(a,b){var d=i(a,{expend:!0});if("replace"===c)h[b]=d;else{if("append"!==c)throw new Error("Unknow mode "+c+", mode must be replace or append.");h.push(d)}}),t(h,b.pageSize||h.$_collection._private.pageSize,e),h.$fetching=!1,d.resolve(a)})},g.onError=function(a){n(function(){h.$fetching=!1,d.reject(a)})},this.$_collection.getEntities(e,f,g),d.promise},v=function(){return JSON.stringify(this)},w=function(){var b,c,d,e;return"undefined"!=typeof this.$queryParams?(b=this.$queryParams.start+this.$queryParams.pageSize,c=this.$queryParams.pageSize,d=this.$totalCount):(b=0,c=l,d=l),b>=d?(e=new a.defer,e.promise.$promise=e.promise,e.resolve({noMore:!0}),e.promise):this.$fetch({start:b,pageSize:c},"append")},x=function(){var b,c,d,e;return"undefined"!=typeof this.$queryParams?(b=this.$queryParams.start+this.$queryParams.pageSize,c=this.$queryParams.pageSize,d=this.$totalCount):(b=0,c=l,d=l),b>=d?(e=new a.defer,e.promise.$promise=e.promise,e.resolve({noMore:!0}),e.promise):this.$fetch({start:b,pageSize:c})},y=function(){var b,c,d,e;return"undefined"==typeof this.$queryParams?(d=new a.defer,d.promise.$promise=d.promise,d.reject(new Error("No collection fetched to $prevPage() on.")),d.promise):(b=this.$queryParams.start-this.$queryParams.pageSize,c=this.$queryParams.pageSize,d=new a.defer,d.promise.$promise=d.promise,0>b&&(e=!0,b=0),this.$fetch({start:b,pageSize:c}).$promise.then(function(a){e===!0&&(a.noMore=!0),d.resolve(a)})["catch"](function(a){d.reject(a)}),d.promise)},z=function(){},A=function(b){var c,d={},e=[];return b="object"==typeof b&&b||{},b.select&&(d.autoExpand=b.select),["params","orderBy","pageSize"].forEach(function(a){void 0!==b[a]&&(d[a]=b[a])}),c=a.defer(),e.$promise=c.promise,Object.defineProperty(e,"$fetching",{enumerable:!1,writable:!0,configurable:!0}),n(function(){e.$fetching=!0}),d.onSuccess=function(a){n(function(){q.wafEntityCollectionToNgWakEntityCollection(e,a.result,d),t(e,e.$_collection._private.pageSize,0,b.query),e.$fetching=!1,a.result=e,c.resolve(a)})},d.onError=function(a){n(function(){e.$fetching=!1,c.reject(a)})},this.query(b.filter||null,d),e},B=function(a){return a="object"==typeof a&&a||{},a.filter,a.filter=null,this.$query(a)},C=function(b,c){var d={},e=a.defer(),f=i(new g.Entity(this,{}));return c="object"==typeof c&&c||{},d.forceReload="undefined"==typeof c.forceReload?!0:c.forceReload,d.autoExpand=c&&c.select||void 0,f.$promise=e.promise,Object.defineProperty(f,"$fetching",{enumerable:!1,writable:!0,configurable:!0}),f.$fetching=!0,d.onSuccess=function(a){n(function(){f.$_entity=a.entity,delete f.$_key,f.$fetching=!1,a.result=f,e.resolve(a)})},d.onError=function(a){n(function(){f.$fetching=!1,e.reject(a)})},this.getEntity(b,d),f},D={init:function(){var b;arguments[0]instanceof g.Entity?(this.$_entity=arguments[0],b=this.$_entity.getDataClass()):arguments[0]instanceof g.DataClass&&"undefined"!=typeof arguments[1]&&(this.$_key=arguments[1],b=arguments[0]),this.$_dataClass=b,Object.defineProperty(this,"$_dataClass",{enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(this,"$_entity",{enumerable:!1,configurable:!1,writable:!0}),b.getAttributes().forEach(function(b){if("relatedEntity"===b.kind)Object.defineProperty(this,b.name,{enumerable:!0,configurable:!0,get:function(){return h(this,b.name)},set:function(a){this.$_entity&&n(function(){this.$_entity[b.name].setValue(a.$_entity),this[b.name].$_entity=a.$_entity}.bind(this))}});else if("relatedEntities"===b.kind)Object.defineProperty(this,b.name,{enumerable:!!this.$_entity,configurable:!0,get:function(){if(this._related||Object.defineProperty(this,"_related",{value:{},enumerable:!1,writable:!0,configurable:!0}),this._related[b.name])return this._related[b.name];var a=[];if(!this.$_entity)throw new Error("Can't get relatedEntities '"+b.name+"' before fetching the entity, please use $fetch before !");return a.$_collection=this.$_entity[b.name],q.addFrameworkMethodsToNestedCollection(a),this.$_entity[b.name].value.__ENTITIES&&a.$fetch(),this._related[b.name]=a,a},set:function(){throw new Error("Can't set relatedEntities attribute "+b.name+".")}});else if("calculated"===b.kind||"alias"===b.kind)Object.defineProperty(this,b.name,{enumerable:!0,configurable:!0,get:function(){return this.$_entity?this.$_entity[b.name].getValue():void 0},set:function(a){if(this.$_entity){if(b.readOnly===!0)throw new Error("Attribute "+b.name+" is readOnly (you may want to declare a setter server-side).");n(function(){this.$_entity[b.name].setValue(a)}.bind(this))}}});else if("image"===b.type){var c=this,d={};Object.defineProperty(this,b.name,{enumerable:!0,configurable:!0,get:function(){var a=c.$_entity[b.name];if(!a.resolvedID){var e=a.getValue();e?d.__deferred=angular.extend({},e.__deferred):delete d.__deferred}return d},set:function(a){var d=c.$_entity[b.name];d.setValue(a)}}),Object.defineProperty(d,"uri",{enumerable:!0,configurable:!0,get:function(){return this.__deferred&&this.__deferred.uri},set:function(a){throw new Error("Attribute "+b.name+" is an image, your must use $upload method or assign the value directly to the attribute.")}}),d.$upload=function(e){var f=a.defer(),g={onSuccess:function(a){f.resolve(a)},onError:function(a){f.reject(a)},timeout:300},h=c.$_entity[b.name];if(f.promise.$promise=f.promise,e)h.setValue(e);else if(!h.unResolvedFile)throw new Error("there is no file to upload !");h.resolveFile(g);var i=new FileReader;return i.readAsDataURL(e),i.onloadend=function(a){d.__deferred||(d.__deferred={}),d.__deferred.uri=i.result},f.promise}}else"object"===b.type&&"storage"===b.kind?("object"!=typeof this.$_objectAttributesOriginalValueStr&&(this.$_objectAttributesOriginalValueStr={}),this.$_objectAttributesOriginalValueStr[b.name]=JSON.stringify(this.$_entity[b.name].getValue()),Object.defineProperty(this,b.name,{enumerable:!0,configurable:!0,get:function(){return this.$_entity?this.$_entity[b.name].getValue():void 0},set:function(a){this.$_entity&&n(function(){this.$_entity[b.name].setValue(a)}.bind(this))}})):Object.defineProperty(this,b.name,{enumerable:!0,configurable:!0,get:function(){return this.$_entity?this.$_entity[b.name].getValue():void 0},set:function(a){this.$_entity&&n(function(){this.$_entity[b.name].setValue(a)}.bind(this))}})}.bind(this))},$key:function(){return this.$_entity?this.$_entity.getKey():this.$_key?this.$_key:void 0},$stamp:function(){return this.$_entity?this.$_entity.getStamp():void 0},$isNew:function(){return this.$_entity?this.$_entity.isNew():void 0},$save:function(){if(!this.$_entity)throw new Error("Can't $save() without pointer, please $fetch() before.");var b=this;this.$_dataClass.getAttributes().forEach(function(a){"object"===a.type&&"storage"===a.kind&&b.$_entity[a.name].isTouched()===!1&&b.$_objectAttributesOriginalValueStr[a.name]!==JSON.stringify(b.$_entity[a.name].value)&&b.$_entity[a.name].touch()});var c,d={},e=this;return c=a.defer(),c.promise.$promise=c.promise,d.onSuccess=function(a){n(function(){q.cleanNgWakEntityAfterSave(e),c.resolve(a)})},d.onError=function(a){n(function(){c.reject(a)})},this.$_entity.save(d),c.promise},$remove:function(){if(!this.$_entity)throw new Error("Can't $remove() without pointer, please $fetch() before.");var b,c={};return b=a.defer(),b.promise.$promise=b.promise,c.onSuccess=function(a){n(function(){b.resolve(a)})},c.onError=function(a){n(function(){b.reject(a)})},this.$_entity.remove(c),b.promise},$fetch:function(b){var c,d,e={};if(b="undefined"==typeof b?{}:b,!this.$key())throw new Error("$fetch error - no key nor pointer was found");c=this.$key(),d=a.defer(),d.promise.$promise=d.promise;var f=this;return Object.defineProperty(f,"$fetching",{enumerable:!1,writable:!0,configurable:!0}),n(function(){f.$fetching=!0}),e.onSuccess=function(a){n(function(){f.$_entity=a.entity,delete f.$_key,f.$fetching=!1,a.result=f,f.$_dataClass.$_relatedAttributes.forEach(function(a){"relatedEntities"===a.kind&&Object.defineProperty(f,a.name,{enumerable:!0})}),d.resolve(a)})},e.onError=function(a){n(function(){f.$fetching=!1,d.resolve(a)})},e.forceReload="undefined"==typeof b.forceReload?!0:b.forceReload,this.$_dataClass.getEntity(c,e),d.promise},$isLoaded:function(){return this.$_entity?!0:!1},$toJSON:v,$serverRefresh:function(b){var c=a.defer();if(b=b||{},c.promise.$promise=c.promise,!this.$_entity)throw new Error("Can't $serverRefresh() without pointer, please $fetch() before.");var d={onSuccess:function(a){n(function(){c.resolve(a)})},onError:function(a){n(function(){c.reject(a)})}};return void 0!==b.forceReload&&(d.forceReload=b.forceReload),this.$_entity.serverRefresh(d),c.promise},toJSON:function(){for(var a={},b=0;b<this.$_dataClass._private.attributes.length;b++){var c=this.$_dataClass._private.attributes[b],d=this.$_entity[c.name];switch(c.kind){case"relatedEntity":"string"==typeof this[c.name].$_key?a[c.name]={ID:parseInt(d.relKey)}:null===this[c.name].$_key?a[c.name]=null:a[c.name]=this[c.name];break;default:a[c.name]=this[c.name]}}return a}},E=f.extend(D),F=function(b,c){var d,e={},f=this;return c=c||"replace",b=b||{},d=a.defer(),d.promise.$promise=d.promise,e.skip=b.start="undefined"==typeof b.start?this.$queryParams?this.$queryParams.start:0:b.start,e.top=b.pageSize="undefined"==typeof b.pageSize?this.$queryParams?this.$queryParams.pageSize:l:b.pageSize,void 0!==b.select&&(e.autoExpand=b.select),b.orderBy&&(e.orderby=b.orderBy),Object.defineProperty(f,"$fetching",{enumerable:!1,writable:!0,configurable:!0}),n(function(){f.$fetching=!0}),e.onSuccess=function(a){n(function(){"replace"===c&&(f.length=0),a.entityCollection.forEach({onSuccess:function(a){var b=i(a.entity,{expend:!0});n(function(){f.push(b)})},first:e.skip,limit:e.skip+e.top}),f.$_isLoaded=!0,s(f,b.pageSize,b.start),f.$totalCount=a.entityCollection.length,f.$fetching=!1,d.resolve(f)})},e.onError=function(a){n(function(){f.$fetching=!1,d.reject(a)})},f.$_collection.getValue(e),d.promise};return m}])}({},function(){return this}());